name: ü§ñ Agent Task Dispatcher

on:
  issues:
    types: [labeled, closed]
  issue_comment:
    types: [created]

jobs:
  dispatch-to-agent:
    runs-on: ubuntu-latest
    if: |
      (github.event.action == 'labeled' && github.event.label.name == 'agent:queued') ||
      (github.event.action == 'created' && contains(github.event.issue.labels.*.name, 'agent:in-progress'))

    steps:
      - name: Validate Issue Template
        id: validate
        run: |
          # Check if issue uses agent template
          if [[ "${{ github.event.issue.body }}" == *"Task Type"* ]]; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Webhook to Agent Server
        if: steps.validate.outputs.valid == 'true'
        env:
          AGENT_WEBHOOK_URL: ${{ secrets.AGENT_WEBHOOK_URL }}
          AGENT_WEBHOOK_SECRET: ${{ secrets.AGENT_WEBHOOK_SECRET }}
        run: |
          # Prepare webhook payload
          payload=$(jq -n \
            --arg event_type "${{ github.event_name }}" \
            --arg action "${{ github.event.action }}" \
            --argjson issue '${{ toJson(github.event.issue) }}' \
            --argjson comment '${{ toJson(github.event.comment) }}' \
            --argjson repository '${{ toJson(github.event.repository) }}' \
            --argjson sender '${{ toJson(github.event.sender) }}' \
            --argjson label '${{ toJson(github.event.label) }}' \
            '{
              event_type: $event_type,
              action: $action,
              issue: $issue,
              comment: $comment,
              repository: $repository,
              sender: $sender,
              label: $label,
              timestamp: now
            }')

          # Generate HMAC signature
          signature=$(echo -n "$payload" | openssl dgst -sha256 -hmac "$AGENT_WEBHOOK_SECRET" | cut -d' ' -f2)

          # Send webhook
          curl -X POST "$AGENT_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$signature" \
            -H "X-GitHub-Event: ${{ github.event_name }}" \
            -H "User-Agent: GitHub-Hookshot/agent-dispatcher" \
            -d "$payload" \
            --fail-with-body

      - name: Checkout repository for gh CLI
        if: failure()
        uses: actions/checkout@v4

      - name: Handle Webhook Failure
        if: failure()
        run: |
          # Comment on issue if webhook fails
          gh issue comment ${{ github.event.issue.number }} \
            --body "‚ö†Ô∏è **Agent Dispatch Failed**

          The agent server could not be reached. Please check:
          - Agent server is running
          - Webhook URL is configured correctly
          - Network connectivity is available

          You can retry by removing and re-adding the \`agent:queued\` label."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

